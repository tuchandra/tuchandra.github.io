<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        Automating Predictive Modeling at Zynga with Pandas UDFs - Tushar Chandra
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" />
  
  <meta name="description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga).
" />
  <meta name="generator" content="Hugo 0.62.2 with theme pure" />
  <title>Automating Predictive Modeling at Zynga with Pandas UDFs - Tushar Chandra</title>
  

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
  <meta property="og:title" content="Automating Predictive Modeling at Zynga with Pandas UDFs" />
<meta property="og:description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/spark/automated_modeling.html" />
<meta property="article:published_time" content="2019-04-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-04-25T00:00:00+00:00" />
<meta itemprop="name" content="Automating Predictive Modeling at Zynga with Pandas UDFs">
<meta itemprop="description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga).">
<meta itemprop="datePublished" content="2019-04-25T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-04-25T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="964">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automating Predictive Modeling at Zynga with Pandas UDFs"/>
<meta name="twitter:description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga)."/>
</head>
  </head>
  

  <body class="main-center theme-blue" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="/">
            <img class="img-circle" src="/headshot.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm"><b>Tushar Chandra</b></h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">Data Scientist</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Chicago, IL</small>
        </div>

        
        <nav id="mobile-navbar" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
          <ul class="mobile-nav">
              <a href="/">
                <li class="menu-item-home">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title"><br>Home</span>
                </li>
              </a>
              <a href="/about">
                <li class="menu-item-about">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title"><br>About</span>
                </li>
              </a>
              <a href="/resume">
                <li class="menu-item-resume">
                    <i class="icon icon-file"></i>
                  <span class="menu-title"><br>Resume</span>
                </li>
              </a>
              <a href="/reading">
                <li class="menu-item-reading">
                    <i class="icon icon-shu-fill"></i>
                  <span class="menu-title"><br>Reading</span>
                </li>
              </a>
              <a href="/categories.html">
                <li class="menu-item-categories">
                    <i class="icon icon-folder-open"></i>
                  <span class="menu-title"><br>Categories</span>
                </li>
              </a>
              <a href="/posts.html">
                <li class="menu-item-archives">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title"><br>Archives</span>
                </li>
              </a>

          </ul>
        </nav>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
            <li class="menu-item menu-item-resume">
                <a href="/resume">
                    <i class="icon icon-file"></i>
                  <span class="menu-title">Resume</span>
                </a>
            </li>
            <li class="menu-item menu-item-reading">
                <a href="/reading">
                    <i class="icon icon-shu-fill"></i>
                  <span class="menu-title">Reading</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories.html">
                    <i class="icon icon-folder-open"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts.html">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>

        </ul>
      </nav>
    </div>
  </header>
<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="/categories/books.html" class="category-list-link">books</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="/categories/general.html" class="category-list-link">general</a><span class="category-list-count">26</span></li>
            <li class="category-list-item"><a href="/categories/papers.html" class="category-list-link">papers</a><span class="category-list-count">21</span></li>
            <li class="category-list-item"><a href="/categories/self.html" class="category-list-link">self</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="/categories/spark.html" class="category-list-link">spark</a><span class="category-list-count">13</span></li>
            <li class="category-list-item"><a href="/categories/what-i-read.html" class="category-list-link">what-i-read</a><span class="category-list-count">17</span></li>
        </ul>
    </div>
</div>
<div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/books/network_propaganda_2.html" class="title">Network Propaganda, part 2</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-18 00:00:00 -0500 CDT" itemprop="datePublished">2020-03-18</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/papers/interpreting_interpretability_kaur.html" class="title">Paper: Interpreting Interpretability: Understanding Data Scientists&#39; Use of Interpretability Tools for Machine Learning</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-17 00:00:00 -0500 CDT" itemprop="datePublished">2020-03-17</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/posts/is_twitter_real_life.html" class="title">Is Twitter real life?</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-16 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-03-16</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/what_i_read/20200315_coronavirus.html" class="title">What I read recently (coronavirus edition)</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-15 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-03-15</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="/what_i_read/20200314.html" class="title">What I read this week (March 8 - March 14)</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-14 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-03-14</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class=""
    href="/spark/automated_modeling.html"
    >Automating Predictive Modeling at Zynga with Pandas UDFs</a
  >
</h1>

      <div class="article-meta">
        <span class="article-date">
  <i class="icon icon-calendar-check"></i>
<a href="/spark/automated_modeling.html">
  <time datetime="2019-04-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-04-25</time>
</a>
</span><span class="article-category">
  <i class="icon icon-folder"></i>
  <a class="article-category-link" href="/categories/spark.html"> spark </a>
</span>

        
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>Speaker: Ben Weber (Principal Data Scientist @ Zynga).</p>
<p>Zynga is a mobile gaming company that has a rich portfolio of games … they have a ton of analytics folks and run an annual internal analytics conference. It brings together all of their analytics folks for knowledge sharing internally.</p>
<ul>
<li>analytics engineering: handling ingestion and data platform, and also live production services</li>
<li>embedded analysts: work on product / game teams, whose job is to improve games and understand how changes might impact games</li>
<li>central analytics: focused on publishing functions, marketing, advertising, corporate development; build data products that any team could use and plug in and scale.</li>
</ul>
<h2 id="challenge">Challenge</h2>
<p>Their challenge is that they want to support game teams to act on their data, but they have a variety of types of games … card games have &ldquo;hands played&rdquo; but match three games have &ldquo;matches made&rdquo; but etc etc etc &hellip;</p>
<p>In other words, they want to build game-specific models for behaviors such as likelihood to purchase, likelihood to churn, etc., but the games have diverse event taxonomies. They have tnes tens of millions of players and dozens of games for multiple platforms.</p>
<h2 id="automodel">AutoModel</h2>
<p>Tool set: <strong>Featuretools</strong> for automating feature engineering, <strong>Pandas UDFs</strong> for distributing Featuretools, and <strong>Databricks / Pyspark</strong> for building the model pipeline.</p>
<p>So they created <strong>AutoModel</strong>, which is their first portfolio-scale product. It generates hundreds of propensity models and powers features in their games &amp; live services. They can plug it in to any new game and have it work out of the game.</p>
<p>The data pipeline is:</p>
<ul>
<li><strong>data extract</strong>, from S3 and parquet files
<ul>
<li>handled by their ingestion and platform team</li>
<li>they use Spark SQL to transform this</li>
</ul>
</li>
<li><strong>feature engineering</strong>, with featuretools
<ul>
<li>&ldquo;here's a deep but narrow format … we want to create a shallow but wide format that we can use later&rdquo;</li>
<li>use featuretools to do this programatically and at scale</li>
</ul>
</li>
<li><strong>feature application</strong>, where you take the featuretools output
<ul>
<li>using Pandas UDFs on Spark</li>
</ul>
</li>
<li>model training using Spark ML</li>
<li>model publish</li>
</ul>
<h3 id="automated-feature-engineering-with-featuretools">Automated Feature Engineering with FeatureTools</h3>
<p>Goals include:</p>
<ul>
<li>translate narrow and deep data tables into a shallow and wide representation</li>
<li>support dozens of titles with diverse event taxonomies</li>
<li>scale to billions of records and millions of players</li>
<li>minimize manual data science workflows</li>
</ul>
<p>Instead of a data scientist saying &ldquo;count the number of distinct days played,&rdquo; they use this to automate that and much more.</p>
<p><strong><a href="https://github.com/Featuretools/featuretools">Feature Tools</a></strong> is a library for deep feature synthesis. Represent your data as entity sets and identify feature descriptors for transforming data into new representations. They went into detail about the entity set; you have entities customers and transactions, which share a customer_id relationship … etc.</p>
<p>Once you've done that, you can perform <strong>deep feature synthesis</strong>. It comes up with a ton of different features for you. He went on and demoed some code about how they did this.</p>
<p>&ldquo;For anyone worried about GDPR, this isn't our dataset, it's a sample dataset … that's a note for our legal team.&rdquo; Love it.</p>
<h3 id="scaling-up-via-pandas-udfs">Scaling up via Pandas UDFs</h3>
<p>FeatureTools only works on a Pandas dataframe, so uh oh. Their options were to either (1) parallelize the process, (2) translate feature descriptions to Spark SQL, or (3) find a way to distribute the task.</p>
<ul>
<li>Parallelizing the process was just way too daunting to be able to do</li>
<li>Translating to Spark SQL worked but still didn't work very well, it was still slow</li>
<li>So they had to learn about Pandas UDFs.</li>
</ul>
<p><strong>Pandas UDFs</strong> were introduced in Spark 2.3, and it lets you partition the Spark DF into Pandas DFs across your cluster, do a computation, then bring it back to Spark. Each worker takes a Pandas input, runs UDFs on it, and generates a Pandas output. PyArrow does the conversion between Spark and Pandas.</p>
<p>You can use Pandas UDFs when:</p>
<ul>
<li>you need to operate on Pandas data frames</li>
<li>your data can be represented as a single Spark data frame</li>
<li>and you can partition your dataset.</li>
</ul>
<p>See this <a href="https://towardsdatascience.com/automated-feature-engineering-for-predictive-modeling-d8c9fa4e478b">Towards Data Science article</a> for an example of distributing this.</p>
<p>But then they hit a lot of issues:</p>
<ul>
<li>debugging is a challenge; since you're executing on worker nodes, you have to go to the Spark logs to see what's going on when an exception occurs</li>
<li>pushing the limits of PyArrow, they found some edge cases that were open Github issues</li>
<li>Pandas UDFs are also newer and so you're going to hit some edge case bugs</li>
<li>data type mismatches between Pandas and Spark caused bugs, too</li>
<li>the schema needs to be known before the UDF is computed; for them, this means they have to do a sampling step where they figure out what the schema will be after deep feature synthesis happens … but you can't just distribute DFS and go.</li>
</ul>
<h3 id="modeling-and-publishing">Modeling and Publishing</h3>
<p>They use gradient boosted trees and XGBoost for classification. They tune hyperparameters with ParamGridBuilder and CrossValidator. Great, that's all standard.</p>
<p>They publish to Couchbase for game teams to use. Then they decided to productionalize with Databricks — a driver notebook can use the jobs API to have different models running for different games in different notebooks.</p>
<h3 id="other-uses-of-pandas-udfs">Other uses of Pandas UDFs</h3>
<p>They found out ways to distribute statsmodels, scipy, and numpy to help distribute experimentation. None of these were intended to be run on Spark, but Pandas UDFs enables this … as long as you can partition your data in some way.</p>
<p><strong>Old approach</strong>: custom data science and engineering work for each model, months-long development process, and an ad-hoc process for productionalizing models.</p>
<p><strong>New approach</strong>: minimal effort for building new propensity models, and no custom work for new games. Predictions are deployed to their application database. Gonna start using MLflow soon.</p>
<p>Pandas UDFs unlock a new magnitude of processing for Python libraries. Zynga can now use Pyspark to build portfolio-scale data products.</p>
    </div>
    <div class="article-footer">
    </div>
  </article>
</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="/spark/data_agility.html" title="Data Agility - A Journey to Advanced Analytics and ML at Scale"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="/posts/about_website.html"
                    title="How I built my (old) website"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
        </ul>
    </div>
</nav>


</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/tuchandra" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://www.linkedin.com/in/tushar-chandra-76a623b6/" target="_blank" title="linkedin" data-toggle=tooltip data-placement=top >
            <i class="icon icon-linkedin"></i></a></li>
    <li><a href="/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy; 2019 - 2020 Tushar Chandra
    <p style="margin-bottom: 4px">All opinions are my own.</p>
    <div class="publishby">
        Theme: <a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank">Hugo Pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js"></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>

  </body>
</html>
