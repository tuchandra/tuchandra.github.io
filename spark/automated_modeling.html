<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Automating Predictive Modeling at Zynga with Pandas UDFs - Tushar Chandra
    </title>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  <meta http-equiv="window-target" content="_top" /><meta name="description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga).
" />
  <meta name="generator" content="Hugo 0.70.0" />
  <title>Automating Predictive Modeling at Zynga with Pandas UDFs - Tushar Chandra</title>

  
  <link rel="stylesheet" href="css/styles.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">

  <meta property="og:title" content="Automating Predictive Modeling at Zynga with Pandas UDFs" />
<meta property="og:description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/spark/automated_modeling.html" />
<meta property="article:published_time" content="2019-04-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-04-25T00:00:00+00:00" />
<meta itemprop="name" content="Automating Predictive Modeling at Zynga with Pandas UDFs">
<meta itemprop="description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga).">
<meta itemprop="datePublished" content="2019-04-25T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-04-25T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="964">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automating Predictive Modeling at Zynga with Pandas UDFs"/>
<meta name="twitter:description" content="Speaker: Ben Weber (Principal Data Scientist @ Zynga)."/>
</head>
</head>



<body class="h-screen flex flex-col justify-between" itemscope itemtype="http://schema.org/WebPage"><header class="w-screen bg-green-500" itemscope itemtype="http://schema.org/WPHeader">
  <div class="flex max-w-8xl container mx-auto">
    <div class="hidden sm:inline flex items-center">
      <a href="/">
        <img class="rounded-full m-1 md:m-4" src="/headshot.jpg" width="100" height="100">
      </a>
    </div>
    <div class="w-full px-4 flex flex-col lg:flex-row justify-between lg:items-center my-4">
      <div class="xl:flex-grow">
        <a href="/">
          <span class="text-lg sm:text-2xl md:text-3xl font-semibold">Tushar Chandra</span>
          <span class="hidden pl-4 lg:inline"><br></span>
          <span class="text-sm md:text-xl font-thin pl-4 md:pl-0 lg:text-xl">Data Scientist / Chicago, IL
          </span>
        </a>
      </div>
      <nav class="" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="flex lg:justify-between">
          <li class="flex-grow-0 inline pr-1 md:pr-2 xl:px-4">
            <p class="text-center">
              <a href="/about">
                <i class="fas text-green-800 pl-1 md:px-1 text-sm md:text-xl lg:text-2xl fa-mug-hot"></i>
                <span class="font-thin text-sm md:text-lg lg:text-2xl">About</span>
              </a>
            </p>
          </li>
          <li class="flex-grow-0 inline pr-1 md:pr-2 xl:px-4">
            <p class="text-center">
              <a href="/resume">
                <i class="fas text-green-800 pl-1 md:px-1 text-sm md:text-xl lg:text-2xl fa-file"></i>
                <span class="font-thin text-sm md:text-lg lg:text-2xl">Resume</span>
              </a>
            </p>
          </li>
          <li class="flex-grow-0 inline pr-1 md:pr-2 xl:px-4">
            <p class="text-center">
              <a href="/reading">
                <i class="fas text-green-800 pl-1 md:px-1 text-sm md:text-xl lg:text-2xl fa-book-open"></i>
                <span class="font-thin text-sm md:text-lg lg:text-2xl">Reading</span>
              </a>
            </p>
          </li>
          <li class="flex-grow-0 inline pr-1 md:pr-2 xl:px-4">
            <p class="text-center">
              <a href="/categories.html">
                <i class="fas text-green-800 pl-1 md:px-1 text-sm md:text-xl lg:text-2xl fa-folder-open"></i>
                <span class="font-thin text-sm md:text-lg lg:text-2xl">Categories</span>
              </a>
            </p>
          </li>
          <li class="flex-grow-0 inline pr-1 md:pr-2 xl:px-4">
            <p class="text-center">
              <a href="/posts.html">
                <i class="fas text-green-800 pl-1 md:px-1 text-sm md:text-xl lg:text-2xl fa-archive"></i>
                <span class="font-thin text-sm md:text-lg lg:text-2xl">Archives</span>
              </a>
            </p>
          </li>

        </ul>

      </nav>
    </div>

  </div>
</header>
  <div class="container mx-auto max-w-8xl px-4 flex flex-row flex-grow">
    <div class="w-full md:w-3/4">
      
<main class="main" role="main"><div class="content container mx-auto max-w-6xl">
  <article id="-" class="" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="pt-4">
      <span class="font-semibold text-3xl"><h1 itemprop="name">
  <a class="" href="/spark/automated_modeling.html">Automating Predictive Modeling at Zynga with Pandas UDFs</a>
</h1>
      </span>
      <div class="pb-4"><i class="fas fa-calendar-check text-gray-500 pr-1"></i>
<time datetime="2019-04-25 00:00:00 &#43;0000 UTC" class="text-sm text-gray-600"
  itemprop="datePublished">2019-04-25</time>
<span class="text-sm text-gray-600" itemprop="wordCount">
	<i class="fas fa-pencil-alt text-gray-500 pl-4 pr-2"></i>964 words
</span><i class="fas fa-folder-open text-gray-500 pl-4 pr-1"></i>
<a class="text-sm text-gray-600" href=" /categories/spark.html"> spark, </a>

      </div>
    </div>
    <div class="rich-text" itemprop="articleBody">
      <p>Speaker: Ben Weber (Principal Data Scientist @ Zynga).</p>
<p>Zynga is a mobile gaming company that has a rich portfolio of games … they have a ton of analytics folks and run an annual internal analytics conference. It brings together all of their analytics folks for knowledge sharing internally.</p>
<ul>
<li>analytics engineering: handling ingestion and data platform, and also live production services</li>
<li>embedded analysts: work on product / game teams, whose job is to improve games and understand how changes might impact games</li>
<li>central analytics: focused on publishing functions, marketing, advertising, corporate development; build data products that any team could use and plug in and scale.</li>
</ul>
<h2 id="challenge">Challenge</h2>
<p>Their challenge is that they want to support game teams to act on their data, but they have a variety of types of games … card games have &ldquo;hands played&rdquo; but match three games have &ldquo;matches made&rdquo; but etc etc etc &hellip;</p>
<p>In other words, they want to build game-specific models for behaviors such as likelihood to purchase, likelihood to churn, etc., but the games have diverse event taxonomies. They have tnes tens of millions of players and dozens of games for multiple platforms.</p>
<h2 id="automodel">AutoModel</h2>
<p>Tool set: <strong>Featuretools</strong> for automating feature engineering, <strong>Pandas UDFs</strong> for distributing Featuretools, and <strong>Databricks / Pyspark</strong> for building the model pipeline.</p>
<p>So they created <strong>AutoModel</strong>, which is their first portfolio-scale product. It generates hundreds of propensity models and powers features in their games &amp; live services. They can plug it in to any new game and have it work out of the game.</p>
<p>The data pipeline is:</p>
<ul>
<li><strong>data extract</strong>, from S3 and parquet files
<ul>
<li>handled by their ingestion and platform team</li>
<li>they use Spark SQL to transform this</li>
</ul>
</li>
<li><strong>feature engineering</strong>, with featuretools
<ul>
<li>&ldquo;here&rsquo;s a deep but narrow format … we want to create a shallow but wide format that we can use later&rdquo;</li>
<li>use featuretools to do this programatically and at scale</li>
</ul>
</li>
<li><strong>feature application</strong>, where you take the featuretools output
<ul>
<li>using Pandas UDFs on Spark</li>
</ul>
</li>
<li>model training using Spark ML</li>
<li>model publish</li>
</ul>
<h3 id="automated-feature-engineering-with-featuretools">Automated Feature Engineering with FeatureTools</h3>
<p>Goals include:</p>
<ul>
<li>translate narrow and deep data tables into a shallow and wide representation</li>
<li>support dozens of titles with diverse event taxonomies</li>
<li>scale to billions of records and millions of players</li>
<li>minimize manual data science workflows</li>
</ul>
<p>Instead of a data scientist saying &ldquo;count the number of distinct days played,&rdquo; they use this to automate that and much more.</p>
<p><strong><a href="https://github.com/Featuretools/featuretools">Feature Tools</a></strong> is a library for deep feature synthesis. Represent your data as entity sets and identify feature descriptors for transforming data into new representations. They went into detail about the entity set; you have entities customers and transactions, which share a customer_id relationship … etc.</p>
<p>Once you&rsquo;ve done that, you can perform <strong>deep feature synthesis</strong>. It comes up with a ton of different features for you. He went on and demoed some code about how they did this.</p>
<p>&ldquo;For anyone worried about GDPR, this isn&rsquo;t our dataset, it&rsquo;s a sample dataset … that&rsquo;s a note for our legal team.&rdquo; Love it.</p>
<h3 id="scaling-up-via-pandas-udfs">Scaling up via Pandas UDFs</h3>
<p>FeatureTools only works on a Pandas dataframe, so uh oh. Their options were to either (1) parallelize the process, (2) translate feature descriptions to Spark SQL, or (3) find a way to distribute the task.</p>
<ul>
<li>Parallelizing the process was just way too daunting to be able to do</li>
<li>Translating to Spark SQL worked but still didn&rsquo;t work very well, it was still slow</li>
<li>So they had to learn about Pandas UDFs.</li>
</ul>
<p><strong>Pandas UDFs</strong> were introduced in Spark 2.3, and it lets you partition the Spark DF into Pandas DFs across your cluster, do a computation, then bring it back to Spark. Each worker takes a Pandas input, runs UDFs on it, and generates a Pandas output. PyArrow does the conversion between Spark and Pandas.</p>
<p>You can use Pandas UDFs when:</p>
<ul>
<li>you need to operate on Pandas data frames</li>
<li>your data can be represented as a single Spark data frame</li>
<li>and you can partition your dataset.</li>
</ul>
<p>See this <a href="https://towardsdatascience.com/automated-feature-engineering-for-predictive-modeling-d8c9fa4e478b">Towards Data Science article</a> for an example of distributing this.</p>
<p>But then they hit a lot of issues:</p>
<ul>
<li>debugging is a challenge; since you&rsquo;re executing on worker nodes, you have to go to the Spark logs to see what&rsquo;s going on when an exception occurs</li>
<li>pushing the limits of PyArrow, they found some edge cases that were open Github issues</li>
<li>Pandas UDFs are also newer and so you&rsquo;re going to hit some edge case bugs</li>
<li>data type mismatches between Pandas and Spark caused bugs, too</li>
<li>the schema needs to be known before the UDF is computed; for them, this means they have to do a sampling step where they figure out what the schema will be after deep feature synthesis happens … but you can&rsquo;t just distribute DFS and go.</li>
</ul>
<h3 id="modeling-and-publishing">Modeling and Publishing</h3>
<p>They use gradient boosted trees and XGBoost for classification. They tune hyperparameters with ParamGridBuilder and CrossValidator. Great, that&rsquo;s all standard.</p>
<p>They publish to Couchbase for game teams to use. Then they decided to productionalize with Databricks — a driver notebook can use the jobs API to have different models running for different games in different notebooks.</p>
<h3 id="other-uses-of-pandas-udfs">Other uses of Pandas UDFs</h3>
<p>They found out ways to distribute statsmodels, scipy, and numpy to help distribute experimentation. None of these were intended to be run on Spark, but Pandas UDFs enables this … as long as you can partition your data in some way.</p>
<p><strong>Old approach</strong>: custom data science and engineering work for each model, months-long development process, and an ad-hoc process for productionalizing models.</p>
<p><strong>New approach</strong>: minimal effort for building new propensity models, and no custom work for new games. Predictions are deployed to their application database. Gonna start using MLflow soon.</p>
<p>Pandas UDFs unlock a new magnitude of processing for Python libraries. Zynga can now use Pyspark to build portfolio-scale data products.</p>
    </div>
    <div class="article-footer">
    </div>
  </article>
</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="/spark/data_agility.html" title="Data Agility - A Journey to Advanced Analytics and ML at Scale"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;</span></a>
            </li>
            <li class="next">
                <a href="/posts/about_website.html"
                    title="How I built my (old) website"><span>&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
        </ul>
    </div>
</nav>

</main>
    </div>
    <div class="hidden w-0 md:block md:w-1/4 md:pt-8 md:pl-12"><aside class="" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="pb-8">
    <h3 class="font-semibold text-xl">Categories</h3>
    <ul class="">
        <li class="">+ <a href="/categories/books.html" class="font-bold text-green-900">books
            </a><span class="">7</span>
        </li>
        <li class="">+ <a href="/categories/chi2020.html" class="font-bold text-green-900">chi2020
            </a><span class="">19</span>
        </li>
        <li class="">+ <a href="/categories/general.html" class="font-bold text-green-900">general
            </a><span class="">33</span>
        </li>
        <li class="">+ <a href="/categories/papers.html" class="font-bold text-green-900">papers
            </a><span class="">46</span>
        </li>
        <li class="">+ <a href="/categories/projects.html" class="font-bold text-green-900">projects
            </a><span class="">7</span>
        </li>
        <li class="">+ <a href="/categories/self.html" class="font-bold text-green-900">self
            </a><span class="">3</span>
        </li>
        <li class="">+ <a href="/categories/spark.html" class="font-bold text-green-900">spark
            </a><span class="">32</span>
        </li>
        <li class="">+ <a href="/categories/what-i-read.html" class="font-bold text-green-900">what-i-read
            </a><span class="">29</span>
        </li>
    </ul>
</div>
<div class="pb-12">
    <h3 class="font-semibold text-xl">Recent Posts</h3>
    <ul class="recent-post-list list-unstyled no-thumbnail">
        <li class="pb-4">
            <p>
                <a href="/books/network_propaganda_4.html" class="font-bold text-green-900">Network Propaganda, part 4</a>
                <time datetime="2020-06-27 00:00:00 &#43;0000 UTC" itemprop="datePublished" class="text-gray-600 text-sm">2020-06-27
                </time>
            </p>

        </li>
        <li class="pb-4">
            <p>
                <a href="/what_i_read/20200627.html" class="font-bold text-green-900">What I read this week (June 21 - 27)</a>
                <time datetime="2020-06-27 00:00:00 &#43;0000 UTC" itemprop="datePublished" class="text-gray-600 text-sm">2020-06-27
                </time>
            </p>

        </li>
        <li class="pb-4">
            <p>
                <a href="/spark/2020/census_differential_privacy.html" class="font-bold text-green-900">Using Apache Spark And Differential Privacy For Protecting The Privacy Of The 2020 Census Respondents</a>
                <time datetime="2020-06-26 14:00:00 &#43;0000 UTC" itemprop="datePublished" class="text-gray-600 text-sm">2020-06-26
                </time>
            </p>

        </li>
        <li class="pb-4">
            <p>
                <a href="/spark/2020/follow_recommendations_linkedin.html" class="font-bold text-green-900">Scoring At Scale: Generating Follow Recommendations For Over 690 Million LinkedIn Members</a>
                <time datetime="2020-06-26 13:30:00 &#43;0000 UTC" itemprop="datePublished" class="text-gray-600 text-sm">2020-06-26
                </time>
            </p>

        </li>
        <li class="pb-4">
            <p>
                <a href="/spark/2020/generalized_seir_models.html" class="font-bold text-green-900">Generalized SEIR Model On Large Networks</a>
                <time datetime="2020-06-26 13:00:00 &#43;0000 UTC" itemprop="datePublished" class="text-gray-600 text-sm">2020-06-26
                </time>
            </p>

        </li>
    </ul>
</div>
</aside><footer class="" itemscope itemtype="http://schema.org/WPFooter">
  <div class="py-4 text-sm">
    &copy; 2019 - 2020 Tushar Chandra
    <p style="margin-bottom: 4px">All opinions are my own.</p>
    <div class="publishby">Theme: custom built.</div>
  </div>
  <ul class="">
    <li class="inline text-xl pr-4">
      <a href="https://github.com/tuchandra" target="_blank" title="github">
        <i class="fab fa-github"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="https://www.linkedin.com/in/tushar-chandra-76a623b6/" target="_blank" title="linkedin">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="mailto:me@tusharc.dev" target="_blank" title="envelope">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="/index.xml" target="_blank" title="rss">
        <i class="fas fa-rss"></i>
      </a>
    </li>

  </ul>
</footer>
    </div>
  </div>
  <div class="mx-auto w-screen px-4 bg-green-500 mt-4 md:py-8">
    <div class="md:invisible md:hidden max-w-8xl"><footer class="" itemscope itemtype="http://schema.org/WPFooter">
  <div class="py-4 text-sm">
    &copy; 2019 - 2020 Tushar Chandra
    <p style="margin-bottom: 4px">All opinions are my own.</p>
    <div class="publishby">Theme: custom built.</div>
  </div>
  <ul class="">
    <li class="inline text-xl pr-4">
      <a href="https://github.com/tuchandra" target="_blank" title="github">
        <i class="fab fa-github"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="https://www.linkedin.com/in/tushar-chandra-76a623b6/" target="_blank" title="linkedin">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="mailto:me@tusharc.dev" target="_blank" title="envelope">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
    <li class="inline text-xl pr-4">
      <a href="/index.xml" target="_blank" title="rss">
        <i class="fas fa-rss"></i>
      </a>
    </li>

  </ul>
</footer>
    </div>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js"></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>


<script data-goatcounter="https://tusharc.goatcounter.com/count" async src="//gc.zgo.at/count.js">
</script>
</body>

</html>